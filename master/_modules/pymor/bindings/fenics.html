
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pymor.bindings.fenics &#8212; pyMOR v2019.2rc0+1426.g15e99291 Manual</title>
    <link rel="stylesheet" href="../../../_static/pymor.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/jupyter-sphinx.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pyMOR v2019.2rc0+1426.g15e99291 Manual</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymor.bindings.fenics</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymor.bindings.fenics</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of the pyMOR project (http://www.pymor.org).</span>
<span class="c1"># Copyright 2013-2020 pyMOR developers and contributors. All rights reserved.</span>
<span class="c1"># License: BSD 2-Clause License (http://opensource.org/licenses/BSD-2-Clause)</span>

<span class="kn">from</span> <span class="nn">pymor.core.config</span> <span class="kn">import</span> <span class="n">config</span>


<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">HAVE_FENICS</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dolfin</span> <span class="k">as</span> <span class="nn">df</span>
    <span class="kn">import</span> <span class="nn">ufl</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="kn">from</span> <span class="nn">pymor.core.base</span> <span class="kn">import</span> <span class="n">BasicObject</span>
    <span class="kn">from</span> <span class="nn">pymor.core.defaults</span> <span class="kn">import</span> <span class="n">defaults</span>
    <span class="kn">from</span> <span class="nn">pymor.operators.constructions</span> <span class="kn">import</span> <span class="n">ZeroOperator</span>
    <span class="kn">from</span> <span class="nn">pymor.operators.interface</span> <span class="kn">import</span> <span class="n">Operator</span>
    <span class="kn">from</span> <span class="nn">pymor.operators.list</span> <span class="kn">import</span> <span class="n">LinearComplexifiedListVectorArrayOperatorBase</span>
    <span class="kn">from</span> <span class="nn">pymor.operators.numpy</span> <span class="kn">import</span> <span class="n">NumpyMatrixOperator</span>
    <span class="kn">from</span> <span class="nn">pymor.vectorarrays.interface</span> <span class="kn">import</span> <span class="n">_create_random_values</span>
    <span class="kn">from</span> <span class="nn">pymor.vectorarrays.list</span> <span class="kn">import</span> <span class="n">CopyOnWriteVector</span><span class="p">,</span> <span class="n">ComplexifiedVector</span><span class="p">,</span> <span class="n">ComplexifiedListVectorSpace</span>
    <span class="kn">from</span> <span class="nn">pymor.vectorarrays.numpy</span> <span class="kn">import</span> <span class="n">NumpyVectorSpace</span>

<div class="viewcode-block" id="FenicsVector"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsVector">[docs]</a>    <span class="k">class</span> <span class="nc">FenicsVector</span><span class="p">(</span><span class="n">CopyOnWriteVector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps a FEniCS vector to make it usable with ListVectorArray.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">impl</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="n">impl</span>

        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">from_instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_copy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ensure_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>  <span class="c1"># always returns a copy</span>

        <span class="k">def</span> <span class="nf">_scal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">*=</span> <span class="n">alpha</span>

        <span class="k">def</span> <span class="nf">_axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scal</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">l1_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">l2_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">l2_norm2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">def</span> <span class="nf">sup_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="s1">&#39;linf&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">dofs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dof_indices</span><span class="p">):</span>
            <span class="n">dof_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dof_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dof_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
            <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dof_indices</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dof_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">dofs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">dof_indices</span><span class="p">)</span>
            <span class="c1"># in the mpi distributed case, gather returns the values</span>
            <span class="c1"># at the *global* dof_indices on each rank</span>
            <span class="k">return</span> <span class="n">dofs</span>

        <span class="k">def</span> <span class="nf">amax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>  <span class="c1"># is implemented for complexified vector</span>

        <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_data_if_needed</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">impl</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="fm">__radd__</span> <span class="o">=</span> <span class="fm">__add__</span>

        <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_data_if_needed</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">-=</span> <span class="n">other</span><span class="o">.</span><span class="n">impl</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span> <span class="o">*</span> <span class="n">other</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span></div>

<div class="viewcode-block" id="ComplexifiedFenicsVector"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.ComplexifiedFenicsVector">[docs]</a>    <span class="k">class</span> <span class="nc">ComplexifiedFenicsVector</span><span class="p">(</span><span class="n">ComplexifiedVector</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">amax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_part</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_local</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">imag_part</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
            <span class="c1"># there seems to be no way in the interface to compute amax without making a copy.</span>
            <span class="n">max_ind_on_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">max_val_on_rank</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">max_ind_on_rank</span><span class="p">]</span>
            <span class="kn">from</span> <span class="nn">pymor.tools</span> <span class="kn">import</span> <span class="n">mpi</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mpi</span><span class="o">.</span><span class="n">parallel</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">max_ind_on_rank</span><span class="p">,</span> <span class="n">max_val_on_rank</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_global_ind_on_rank</span> <span class="o">=</span> <span class="n">max_ind_on_rank</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">local_range</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">mpi_comm</span><span class="p">()</span>
                <span class="n">comm_size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

                <span class="n">max_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">comm_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">Allgather</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_global_ind_on_rank</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">),</span> <span class="n">max_inds</span><span class="p">)</span>

                <span class="n">max_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">comm_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">comm</span><span class="o">.</span><span class="n">Allgather</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_val_on_rank</span><span class="p">),</span> <span class="n">max_vals</span><span class="p">)</span>

                <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">max_vals</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">max_inds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">max_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="FenicsVectorSpace"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsVectorSpace">[docs]</a>    <span class="k">class</span> <span class="nc">FenicsVectorSpace</span><span class="p">(</span><span class="n">ComplexifiedListVectorSpace</span><span class="p">):</span>

        <span class="n">complexified_vector_type</span> <span class="o">=</span> <span class="n">ComplexifiedFenicsVector</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;STATE&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__auto_init</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

<div class="viewcode-block" id="FenicsVectorSpace.__eq__"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsVectorSpace.__eq__">[docs]</a>        <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">is</span> <span class="n">FenicsVectorSpace</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">V</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span></div>

        <span class="c1"># since we implement __eq__, we also need to implement __hash__</span>
<div class="viewcode-block" id="FenicsVectorSpace.__hash__"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsVectorSpace.__hash__">[docs]</a>        <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

        <span class="k">def</span> <span class="nf">real_zero_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">real_full_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="n">impl</span> <span class="o">+=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">real_random_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">_create_random_values</span><span class="p">(</span><span class="n">impl</span><span class="o">.</span><span class="n">local_size</span><span class="p">(),</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">impl</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">real_vector_from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ensure_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="n">impl</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">real_make_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FenicsVector</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="FenicsMatrixOperator"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsMatrixOperator">[docs]</a>    <span class="k">class</span> <span class="nc">FenicsMatrixOperator</span><span class="p">(</span><span class="n">LinearComplexifiedListVectorArrayOperatorBase</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps a FEniCS matrix as an |Operator|.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">source_space</span><span class="p">,</span> <span class="n">range_space</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">matrix</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__auto_init</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">FenicsVectorSpace</span><span class="p">(</span><span class="n">source_space</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">FenicsVectorSpace</span><span class="p">(</span><span class="n">range_space</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_real_apply_one_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prepare_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">real_zero_vector</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="k">def</span> <span class="nf">_real_apply_adjoint_one_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prepare_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">real_zero_vector</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpmult</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">impl</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="k">def</span> <span class="nf">_real_apply_inverse_one_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">least_squares</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prepare_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">least_squares</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">real_zero_vector</span><span class="p">()</span> <span class="k">if</span> <span class="n">initial_guess</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                 <span class="n">initial_guess</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inverse&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_options</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">_apply_inverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="k">def</span> <span class="nf">_assemble_lincomb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operators</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">identity_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">FenicsMatrixOperator</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operators</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">identity_shift</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">coefficients</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">operators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">matrix</span> <span class="o">*</span> <span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">operators</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">matrix</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="c1"># in general, we cannot assume the same nonzero pattern for # all matrices. how to improve this?</span>

            <span class="k">return</span> <span class="n">FenicsMatrixOperator</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">solver_options</span><span class="o">=</span><span class="n">solver_options</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="FenicsOperator"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsOperator">[docs]</a>    <span class="k">class</span> <span class="nc">FenicsOperator</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wraps a FEniCS form as an |Operator|.&quot;&quot;&quot;</span>

        <span class="n">linear</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">source_space</span><span class="p">,</span> <span class="n">range_space</span><span class="p">,</span> <span class="n">source_function</span><span class="p">,</span> <span class="n">dirichlet_bcs</span><span class="o">=</span><span class="p">(),</span>
                     <span class="n">parameter_setter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">solver_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">arguments</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__auto_init</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source_space</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">range_space</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters_own</span> <span class="o">=</span> <span class="n">parameters</span>

        <span class="k">def</span> <span class="nf">_set_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">assert_compatible</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameter_setter</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<div class="viewcode-block" id="FenicsOperator.apply"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsOperator.apply">[docs]</a>        <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">U</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">R</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">source_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_function</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">imag_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="n">source_vec</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_bcs</span><span class="p">:</span>
                    <span class="n">bc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">source_vec</span><span class="p">)</span>
                <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">make_array</span><span class="p">(</span><span class="n">R</span><span class="p">)</span></div>

<div class="viewcode-block" id="FenicsOperator.jacobian"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsOperator.jacobian">[docs]</a>        <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">U</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">U</span><span class="o">.</span><span class="n">_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imag_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">source_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_function</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="n">source_vec</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_function</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_bcs</span><span class="p">:</span>
                <span class="n">bc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FenicsMatrixOperator</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span><span class="p">)</span></div>

<div class="viewcode-block" id="FenicsOperator.restricted"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsOperator.restricted">[docs]</a>        <span class="k">def</span> <span class="nf">restricted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dofs</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">pymor.tools.mpi</span> <span class="kn">import</span> <span class="n">parallel</span>
            <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;SubMesh does not work in parallel&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Restricting operator to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dofs</span><span class="p">)</span><span class="si">}</span><span class="s1"> dofs ...&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dofs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ZeroOperator</span><span class="p">(</span><span class="n">NumpyVectorSpace</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">NumpyVectorSpace</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing affected cells ...&#39;</span><span class="p">)</span>
                <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>
                <span class="n">range_dofmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">dofmap</span><span class="p">()</span>
                <span class="n">affected_cell_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">cells</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
                    <span class="n">cell_index</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
                    <span class="n">local_dofs</span> <span class="o">=</span> <span class="n">range_dofmap</span><span class="o">.</span><span class="n">cell_dofs</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ld</span> <span class="ow">in</span> <span class="n">local_dofs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ld</span> <span class="ow">in</span> <span class="n">dofs</span><span class="p">:</span>
                            <span class="n">affected_cell_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                            <span class="k">continue</span>
                <span class="n">affected_cell_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">affected_cell_indices</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">integral_type</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;exterior_facet&#39;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">integrals</span><span class="p">()):</span>
                    <span class="c1"># enlarge affected_cell_indices if needed</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing source DOFs ...&#39;</span><span class="p">)</span>
                <span class="n">source_dofmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">dofmap</span><span class="p">()</span>
                <span class="n">source_dofs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cell_index</span> <span class="ow">in</span> <span class="n">affected_cell_indices</span><span class="p">:</span>
                    <span class="n">local_dofs</span> <span class="o">=</span> <span class="n">source_dofmap</span><span class="o">.</span><span class="n">cell_dofs</span><span class="p">(</span><span class="n">cell_index</span><span class="p">)</span>
                    <span class="n">source_dofs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local_dofs</span><span class="p">)</span>
                <span class="n">source_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">source_dofs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building submesh ...&#39;</span><span class="p">)</span>
                <span class="n">subdomain</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">MeshFunction</span><span class="p">(</span><span class="s1">&#39;size_t&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">affected_cell_indices</span><span class="p">:</span>
                    <span class="n">subdomain</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">submesh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SubMesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building UFL form on submesh ...&#39;</span><span class="p">)</span>
                <span class="n">form_r</span><span class="p">,</span> <span class="n">V_r_source</span><span class="p">,</span> <span class="n">V_r_range</span><span class="p">,</span> <span class="n">source_function_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_form</span><span class="p">(</span><span class="n">submesh</span><span class="p">,</span> <span class="n">source_dofs</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building DirichletBCs on submesh ...&#39;</span><span class="p">)</span>
                <span class="n">bc_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_dirichlet_bcs</span><span class="p">(</span><span class="n">submesh</span><span class="p">,</span> <span class="n">source_dofs</span><span class="p">,</span> <span class="n">V_r_source</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing source DOF mapping ...&#39;</span><span class="p">)</span>
                <span class="n">restricted_source_dofs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_dof_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">V_r_source</span><span class="p">,</span> <span class="n">source_dofs</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing range DOF mapping ...&#39;</span><span class="p">)</span>
                <span class="n">restricted_range_dofs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_dof_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">V_r_range</span><span class="p">,</span> <span class="n">dofs</span><span class="p">)</span>

                <span class="n">op_r</span> <span class="o">=</span> <span class="n">FenicsOperator</span><span class="p">(</span><span class="n">form_r</span><span class="p">,</span> <span class="n">FenicsVectorSpace</span><span class="p">(</span><span class="n">V_r_source</span><span class="p">),</span> <span class="n">FenicsVectorSpace</span><span class="p">(</span><span class="n">V_r_range</span><span class="p">),</span>
                                      <span class="n">source_function_r</span><span class="p">,</span> <span class="n">dirichlet_bcs</span><span class="o">=</span><span class="n">bc_r</span><span class="p">,</span> <span class="n">parameter_setter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_setter</span><span class="p">,</span>
                                      <span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">(</span><span class="n">RestrictedFenicsOperator</span><span class="p">(</span><span class="n">op_r</span><span class="p">,</span> <span class="n">restricted_range_dofs</span><span class="p">),</span>
                        <span class="n">source_dofs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">restricted_source_dofs</span><span class="p">)])</span></div>

        <span class="k">def</span> <span class="nf">_restrict_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submesh</span><span class="p">,</span> <span class="n">source_dofs</span><span class="p">):</span>
            <span class="n">V_r_source</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">submesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">())</span>
            <span class="n">V_r_range</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">submesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">V_r_source</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_dofs</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">ufl_function_space</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">arguments</span><span class="p">())</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">argument</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="n">V_r_range</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">number</span><span class="p">(),</span> <span class="n">arg</span><span class="o">.</span><span class="n">part</span><span class="p">())</span>
                          <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">ufl_function_space</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">V</span> <span class="k">else</span> <span class="n">arg</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">arguments</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span> <span class="ow">and</span> <span class="n">coeff</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_function</span> <span class="k">for</span> <span class="n">coeff</span> <span class="ow">in</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">coefficients</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

            <span class="n">source_function_r</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_r_source</span><span class="p">)</span>
            <span class="n">form_r</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">replace_integral_domains</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">coefficients</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_function</span><span class="p">:</span> <span class="n">source_function_r</span><span class="p">}),</span>
                <span class="n">submesh</span><span class="o">.</span><span class="n">ufl_domain</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">form_r</span><span class="p">,</span> <span class="n">V_r_source</span><span class="p">,</span> <span class="n">V_r_range</span><span class="p">,</span> <span class="n">source_function_r</span>

        <span class="k">def</span> <span class="nf">_restrict_dirichlet_bcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submesh</span><span class="p">,</span> <span class="n">source_dofs</span><span class="p">,</span> <span class="n">V_r_source</span><span class="p">):</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>
            <span class="n">parent_facet_indices</span> <span class="o">=</span> <span class="n">compute_parent_facet_indices</span><span class="p">(</span><span class="n">submesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">restrict_dirichlet_bc</span><span class="p">(</span><span class="n">bc</span><span class="p">):</span>
                <span class="c1"># ensure that markers are initialized</span>
                <span class="n">bc</span><span class="o">.</span><span class="n">get_boundary_values</span><span class="p">()</span>
                <span class="n">facets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">num_facets</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>
                <span class="n">facets</span><span class="p">[</span><span class="n">bc</span><span class="o">.</span><span class="n">markers</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">facets_r</span> <span class="o">=</span> <span class="n">facets</span><span class="p">[</span><span class="n">parent_facet_indices</span><span class="p">]</span>
                <span class="n">sub_domains</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">MeshFunction</span><span class="p">(</span><span class="s1">&#39;size_t&#39;</span><span class="p">,</span> <span class="n">submesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sub_domains</span><span class="o">.</span><span class="n">array</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">facets_r</span>

                <span class="n">bc_r</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">DirichletBC</span><span class="p">(</span><span class="n">V_r_source</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span> <span class="n">sub_domains</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">method</span><span class="p">())</span>
                <span class="k">return</span> <span class="n">bc_r</span>

            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">restrict_dirichlet_bc</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet_bcs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_build_dof_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">V_r</span><span class="p">,</span> <span class="n">dofs</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
            <span class="n">u_vec</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="n">restricted_dofs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">dofs</span><span class="p">:</span>
                <span class="n">u_vec</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
                <span class="n">u_vec</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">u_r</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">V_r</span><span class="p">)</span>
                <span class="n">u_r</span> <span class="o">=</span> <span class="n">u_r</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_r</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="n">r_dof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_r</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_dof</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="n">restricted_dofs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_dof</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">restricted_dofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">restricted_dofs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">restricted_dofs</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dofs</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">restricted_dofs</span></div>

<div class="viewcode-block" id="RestrictedFenicsOperator"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.RestrictedFenicsOperator">[docs]</a>    <span class="k">class</span> <span class="nc">RestrictedFenicsOperator</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>

        <span class="n">linear</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">restricted_range_dofs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">NumpyVectorSpace</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">NumpyVectorSpace</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">restricted_range_dofs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restricted_range_dofs</span> <span class="o">=</span> <span class="n">restricted_range_dofs</span>

<div class="viewcode-block" id="RestrictedFenicsOperator.apply"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.RestrictedFenicsOperator.apply">[docs]</a>        <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">U</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="n">UU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">uu</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">UU</span><span class="o">.</span><span class="n">_list</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()):</span>
                <span class="n">uu</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">VV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">UU</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">VV</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">VV</span><span class="o">.</span><span class="n">_list</span><span class="p">):</span>
                <span class="n">v</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">vv</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">restricted_range_dofs</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">V</span></div>

<div class="viewcode-block" id="RestrictedFenicsOperator.jacobian"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.RestrictedFenicsOperator.jacobian">[docs]</a>        <span class="k">def</span> <span class="nf">jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">U</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">UU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">zeros</span><span class="p">()</span>
            <span class="n">UU</span><span class="o">.</span><span class="n">_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">JJ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">UU</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">NumpyMatrixOperator</span><span class="p">(</span><span class="n">JJ</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">array</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">restricted_range_dofs</span><span class="p">,</span> <span class="p">:])</span></div></div>

    <span class="nd">@defaults</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="s1">&#39;preconditioner&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_solver_options</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;bicgstab&#39;</span><span class="p">,</span> <span class="n">preconditioner</span><span class="o">=</span><span class="s1">&#39;amg&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;solver&#39;</span><span class="p">:</span> <span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;preconditioner&#39;</span><span class="p">:</span> <span class="n">preconditioner</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_apply_inverse</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="n">_solver_options</span><span class="p">()</span>
        <span class="n">solver</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">)</span>
        <span class="n">preconditioner</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preconditioner&#39;</span><span class="p">)</span>
        <span class="c1"># preconditioner argument may only be specified for iterative solvers:</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">preconditioner</span><span class="p">)</span> <span class="k">if</span> <span class="n">preconditioner</span> <span class="k">else</span> <span class="p">(</span><span class="n">solver</span><span class="p">,)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="FenicsVisualizer"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsVisualizer">[docs]</a>    <span class="k">class</span> <span class="nc">FenicsVisualizer</span><span class="p">(</span><span class="n">BasicObject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize a FEniCS grid function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        space</span>
<span class="sd">            The `FenicsVectorSpace` for which we want to visualize DOF vectors.</span>
<span class="sd">        mesh_refinements</span>
<span class="sd">            Number of uniform mesh refinements to perform for vtk visualization</span>
<span class="sd">            (of functions from higher-order FE spaces).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">mesh_refinements</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">space</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_refinements</span> <span class="o">=</span> <span class="n">mesh_refinements</span>

<div class="viewcode-block" id="FenicsVisualizer.visualize"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.FenicsVisualizer.visualize">[docs]</a>        <span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">separate_colorbars</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Visualize the provided data.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            U</span>
<span class="sd">                |VectorArray| of the data to visualize (length must be 1). Alternatively,</span>
<span class="sd">                a tuple of |VectorArrays| which will be visualized in separate windows.</span>
<span class="sd">                If `filename` is specified, only one |VectorArray| may be provided which,</span>
<span class="sd">                however, is allowed to contain multipled vectors that will be interpreted</span>
<span class="sd">                as a time series.</span>
<span class="sd">            m</span>
<span class="sd">                Filled in by :meth:`pymor.models.interface.Model.visualize` (ignored).</span>
<span class="sd">            title</span>
<span class="sd">                Title of the plot.</span>
<span class="sd">            legend</span>
<span class="sd">                Description of the data that is plotted. If `U` is a tuple of |VectorArrays|,</span>
<span class="sd">                `legend` has to be a tuple of the same length.</span>
<span class="sd">            filename</span>
<span class="sd">                If specified, write the data to that file. `filename` needs to have an extension</span>
<span class="sd">                supported by FEniCS (e.g. `.pvd`).</span>
<span class="sd">            separate_colorbars</span>
<span class="sd">                If `True`, use separate colorbars for each subplot.</span>
<span class="sd">            block</span>
<span class="sd">                If `True`, block execution until the plot window is closed.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">U</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">coarse_function</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_refinements</span><span class="p">:</span>
                    <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_refinements</span><span class="p">):</span>
                        <span class="n">mesh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
                    <span class="n">V_fine</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">())</span>
                    <span class="n">function</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_fine</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">function</span> <span class="o">=</span> <span class="n">coarse_function</span>
                <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
                    <span class="n">function</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span> <span class="n">legend</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="o">.</span><span class="n">_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">imag_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                    <span class="n">coarse_function</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_refinements</span><span class="p">:</span>
                        <span class="n">function</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">coarse_function</span><span class="p">,</span> <span class="n">V_fine</span><span class="p">)</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
                    <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="n">function</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

                <span class="k">assert</span> <span class="n">U</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> \
                    <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">U</span><span class="p">,)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">legend</span> <span class="o">=</span> <span class="p">(</span><span class="n">legend</span><span class="p">,)</span>
                <span class="k">assert</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">separate_colorbars</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">:</span>
                        <span class="n">vec</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vec</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vec</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imag_part</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                    <span class="n">function</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
                    <span class="n">function</span><span class="o">.</span><span class="n">vector</span><span class="p">()[:]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real_part</span><span class="o">.</span><span class="n">impl</span>
                    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
                        <span class="n">tit</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; -- &#39;</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">tit</span> <span class="o">+=</span> <span class="n">legend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tit</span> <span class="o">=</span> <span class="n">title</span>
                    <span class="k">if</span> <span class="n">separate_colorbars</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">tit</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
                                <span class="n">range_min</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">range_max</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span></div></div>

    <span class="c1"># adapted from dolfin.mesh.ale.init_parent_edge_indices</span>
<div class="viewcode-block" id="compute_parent_facet_indices"><a class="viewcode-back" href="../../../generated/pymor.bindings.html#pymor.bindings.fenics.compute_parent_facet_indices">[docs]</a>    <span class="k">def</span> <span class="nf">compute_parent_facet_indices</span><span class="p">(</span><span class="n">submesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">facet_dim</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">submesh</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">facet_dim</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">facet_dim</span><span class="p">)</span>

        <span class="c1"># Make sure we have vertex-facet connectivity for parent mesh</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">facet_dim</span><span class="p">)</span>

        <span class="n">parent_vertex_indices</span> <span class="o">=</span> <span class="n">submesh</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;parent_vertex_indices&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Create the fact map</span>
        <span class="n">parent_facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">submesh</span><span class="o">.</span><span class="n">num_facets</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Iterate over the edges and figure out their parent number</span>
        <span class="k">for</span> <span class="n">local_facet</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">facets</span><span class="p">(</span><span class="n">submesh</span><span class="p">):</span>

            <span class="c1"># Get parent indices for edge vertices</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">local_facet</span><span class="o">.</span><span class="n">entities</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Vertex</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">parent_vertex_indices</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">]</span>

            <span class="c1"># Get outgoing facets from the two parent vertices</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">entities</span><span class="p">(</span><span class="n">facet_dim</span><span class="p">))</span> <span class="k">for</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">Vs</span><span class="p">]</span>

            <span class="c1"># Check intersection</span>
            <span class="n">common_facets</span> <span class="o">=</span> <span class="n">facets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">common_facets</span> <span class="o">=</span> <span class="n">common_facets</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_facets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">parent_facet_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">common_facets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Set value</span>
            <span class="n">parent_facet_indices</span><span class="p">[</span><span class="n">local_facet</span><span class="o">.</span><span class="n">index</span><span class="p">()]</span> <span class="o">=</span> <span class="n">parent_facet_index</span>
        <span class="k">return</span> <span class="n">parent_facet_indices</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pyMOR v2019.2rc0+1426.g15e99291 Manual</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymor.bindings.fenics</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2020 pyMOR developers and contributors.
      Last updated on Jul 16, 2020.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.1.2.
    </div>
  </body>
</html>